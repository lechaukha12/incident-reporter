<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Tuning OPS</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #ffde00;
            color: #0171bb;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            margin: 0;
            font-size: 24px;
        }
        button {
            background-color: #0171bb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #014a8a;
        }
        
        header button {
            background-color: #ffde00;
            color: #0171bb;
            border: 2px solid #0171bb;
        }
        
        header button:hover {
            background-color: #e6c700;
            color: #0171bb;
        }
        .stats {
            display: flex;
            margin: 20px 0;
            gap: 20px;
        }
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h2 {
            font-size: 32px;
            margin: 0 0 10px 0;
            color: #0171bb;
        }
        .table-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #fafafa;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .tag-critical {
            background-color: #ff4d4f;
            color: white;
        }
        .tag-high {
            background-color: #ffde00;
            color: #0171bb;
        }
        .tag-medium {
            background-color: #ffde00;
            color: #0171bb;
        }
        .tag-low {
            background-color: #52c41a;
            color: white;
        }
        .tag-investigating {
            background-color: #ffde00;
            color: #0171bb;
        }
        .tag-identified {
            background-color: #ffde00;
            color: #0171bb;
        }
        .tag-monitoring {
            background-color: #722ed1;
            color: white;
        }
        .tag-resolved {
            background-color: #52c41a;
            color: white;
        }
        .loading {
            text-align: center;
            margin: 50px 0;
            font-size: 18px;
            color: #999;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #0171bb;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #555;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            border-color: #0171bb;
            outline: none;
            box-shadow: 0 0 0 2px rgba(1, 113, 187, 0.2);
        }
        
        select.form-control {
            height: 38px;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-cancel {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #d9d9d9;
        }
        
        .btn-cancel:hover {
            background-color: #e6e6e6;
        }
        
        .btn-submit {
            background-color: #0171bb;
        }
        
        .btn-submit:hover {
            background-color: #014a8a;
        }
    </style>
</head>
<body>
    <header>
        <h1>Hệ thống Tuning OPS</h1>
        <button id="createBtn">
            <span>+</span> Tạo sự cố mới
        </button>
    </header>
    
    <div class="container">
        <div class="stats" id="stats-container">
            <div class="stat-card">
                <h2 id="total-incidents">-</h2>
                <p>Tổng số sự cố</p>
            </div>
            <div class="stat-card">
                <h2 id="active-incidents">-</h2>
                <p>Sự cố đang hoạt động</p>
            </div>
            <div class="stat-card">
                <h2 id="resolved-incidents">-</h2>
                <p>Đã giải quyết</p>
            </div>
        </div>
        
        <div class="table-container">
            <h2>Danh sách sự cố</h2>
            <div id="incidents-table">
                <div class="loading">Đang tải dữ liệu...</div>
            </div>
        </div>
    </div>

    <!-- Modal tạo sự cố mới -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tạo sự cố mới</h2>
                <span class="close">&times;</span>
            </div>
            <form id="createIncidentForm">
                <div class="form-group">
                    <label for="title">Tiêu đề sự cố</label>
                    <input type="text" id="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="description">Mô tả</label>
                    <textarea id="description" class="form-control" required></textarea>
                </div>
                <div class="form-group">
                    <label for="status">Trạng thái</label>
                    <select id="status" class="form-control">
                        <option value="INVESTIGATING">Đang xác định</option>
                        <option value="IDENTIFIED">Đã xác định</option>
                        <option value="MONITORING">Đang theo dõi</option>
                        <option value="RESOLVED">Đã giải quyết</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="severityLevel">Mức độ nghiêm trọng</label>
                    <select id="severityLevel" class="form-control">
                        <option value="CRITICAL">Nghiêm trọng</option>
                        <option value="HIGH" selected>Cao</option>
                        <option value="MEDIUM">Trung bình</option>
                        <option value="LOW">Thấp</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="affectedService">Dịch vụ bị ảnh hưởng</label>
                    <input type="text" id="affectedService" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="reportedBy">Người báo cáo</label>
                    <input type="text" id="reportedBy" class="form-control" required>
                </div>
                <div class="btn-row">
                    <button type="button" class="btn-cancel" id="cancelBtn">Hủy bỏ</button>
                    <button type="submit" class="btn-submit">Tạo sự cố</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal chỉnh sửa sự cố -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chỉnh sửa sự cố</h2>
                <span class="close">&times;</span>
            </div>
            <form id="editIncidentForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label for="editTitle">Tiêu đề sự cố</label>
                    <input type="text" id="editTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editDescription">Mô tả</label>
                    <textarea id="editDescription" class="form-control" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editStatus">Trạng thái</label>
                    <select id="editStatus" class="form-control">
                        <option value="INVESTIGATING">Đang xác định</option>
                        <option value="IDENTIFIED">Đã xác định</option>
                        <option value="MONITORING">Đang theo dõi</option>
                        <option value="RESOLVED">Đã giải quyết</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editSeverityLevel">Mức độ nghiêm trọng</label>
                    <select id="editSeverityLevel" class="form-control">
                        <option value="CRITICAL">Nghiêm trọng</option>
                        <option value="HIGH">Cao</option>
                        <option value="MEDIUM">Trung bình</option>
                        <option value="LOW">Thấp</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editAffectedService">Dịch vụ bị ảnh hưởng</label>
                    <input type="text" id="editAffectedService" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editAssignee">Người phụ trách</label>
                    <input type="text" id="editAssignee" class="form-control">
                </div>
                <div class="btn-row">
                    <button type="button" class="btn-cancel" id="editCancelBtn">Hủy bỏ</button>
                    <button type="submit" class="btn-submit">Cập nhật sự cố</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window.location.hostname === 'localhost' ? 
            'http://localhost:8080/api' : 
            '/api';
        
        // DOM Elements
        const totalIncidentsEl = document.getElementById('total-incidents');
        const activeIncidentsEl = document.getElementById('active-incidents');
        const resolvedIncidentsEl = document.getElementById('resolved-incidents');
        const incidentsTableEl = document.getElementById('incidents-table');
        const createBtn = document.getElementById('createBtn');
        const createModal = document.getElementById('createModal');
        const closeModalBtn = document.querySelector('#createModal .close');
        const cancelBtn = document.getElementById('cancelBtn');
        const createIncidentForm = document.getElementById('createIncidentForm');
        
        // Edit Modal Elements
        const editModal = document.getElementById('editModal');
        const editCloseModalBtn = document.querySelector('#editModal .close');
        const editCancelBtn = document.getElementById('editCancelBtn');
        const editIncidentForm = document.getElementById('editIncidentForm');
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchStats();
            fetchIncidents();
            
            // Add event listeners for create modal
            createBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            createIncidentForm.addEventListener('submit', createIncident);
            
            // Add event listeners for edit modal
            editCloseModalBtn.addEventListener('click', closeEditModal);
            editCancelBtn.addEventListener('click', closeEditModal);
            editIncidentForm.addEventListener('submit', updateIncident);
            
            // Close modals when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === createModal) {
                    closeModal();
                }
                if (event.target === editModal) {
                    closeEditModal();
                }
            });
        });
        
        // Open modal
        function openModal() {
            createModal.style.display = 'block';
        }
        
        // Close modal
        function closeModal() {
            createModal.style.display = 'none';
            createIncidentForm.reset();
        }
        
        // Create new incident
        function createIncident(event) {
            event.preventDefault();
            
            const newIncident = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                status: document.getElementById('status').value,
                severityLevel: document.getElementById('severityLevel').value,
                affectedService: document.getElementById('affectedService').value,
                reportedBy: document.getElementById('reportedBy').value
            };
            
            fetch(`${API_BASE_URL}/incidents`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newIncident)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Refresh data
                fetchStats();
                fetchIncidents();
                closeModal();
                alert('Đã tạo sự cố mới thành công!');
            })
            .catch(error => {
                console.error('Error creating incident:', error);
                alert(`Lỗi khi tạo sự cố: ${error.message}`);
            });
        }
        
        // Fetch statistics
        function fetchStats() {
            fetch(`${API_BASE_URL}/incidents/stats`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    totalIncidentsEl.textContent = data.totalIncidents || 0;
                    activeIncidentsEl.textContent = data.activeIncidents || 0;
                    resolvedIncidentsEl.textContent = data.resolvedIncidents || 0;
                })
                .catch(error => {
                    console.error('Error fetching stats:', error);
                });
        }
        
        // Fetch incidents
        function fetchIncidents() {
            fetch(`${API_BASE_URL}/incidents`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    renderIncidentsTable(data.content || []);
                })
                .catch(error => {
                    console.error('Error fetching incidents:', error);
                    incidentsTableEl.innerHTML = `
                        <div style="color: #ff4d4f; text-align: center; padding: 20px;">
                            Có lỗi khi tải dữ liệu. Vui lòng thử lại sau.
                        </div>
                    `;
                });
        }
        
        // Render incidents table
        function renderIncidentsTable(incidents) {
            if (incidents.length === 0) {
                incidentsTableEl.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        Không có sự cố nào.
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tiêu đề</th>
                            <th>Trạng thái</th>
                            <th>Mức độ nghiêm trọng</th>
                            <th>Dịch vụ bị ảnh hưởng</th>
                            <th>Người báo cáo</th>
                            <th>Thời gian tạo</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${incidents.map(incident => `
                            <tr>
                                <td>${incident.id}</td>
                                <td>${incident.title}</td>
                                <td><span class="tag tag-${incident.status.toLowerCase()}">${getStatusLabel(incident.status)}</span></td>
                                <td><span class="tag tag-${incident.severityLevel.toLowerCase()}">${getSeverityLabel(incident.severityLevel)}</span></td>
                                <td>${incident.affectedService || '-'}</td>
                                <td>${incident.reportedBy || '-'}</td>
                                <td>${formatDate(incident.createdAt)}</td>
                                <td>
                                    <button onclick="openEditModal(${incident.id})" class="btn-edit" style="background-color: #0171bb; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                        Sửa
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            incidentsTableEl.innerHTML = tableHTML;
        }
        
        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }
        
        // Helper function to get status labels
        function getStatusLabel(status) {
            const statusMap = {
                'INVESTIGATING': 'Đang xác định',
                'IDENTIFIED': 'Đã xác định',
                'MONITORING': 'Đang theo dõi',
                'RESOLVED': 'Đã giải quyết'
            };
            return statusMap[status] || status;
        }
        
        // Helper function to get severity labels
        function getSeverityLabel(severity) {
            const severityMap = {
                'CRITICAL': 'Nghiêm trọng',
                'HIGH': 'Cao',
                'MEDIUM': 'Trung bình',
                'LOW': 'Thấp'
            };
            return severityMap[severity] || severity;
        }
        // Open edit modal
        function openEditModal(id) {
            fetch(`${API_BASE_URL}/incidents/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(incident => {
                    document.getElementById('editId').value = incident.id;
                    document.getElementById('editTitle').value = incident.title;
                    document.getElementById('editDescription').value = incident.description;
                    document.getElementById('editStatus').value = incident.status;
                    document.getElementById('editSeverityLevel').value = incident.severityLevel;
                    document.getElementById('editAffectedService').value = incident.affectedService || '';
                    document.getElementById('editAssignee').value = incident.assignee || '';
                    
                    editModal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching incident details:', error);
                    alert(`Lỗi khi tải thông tin sự cố: ${error.message}`);
                });
        }
        
        // Close edit modal
        function closeEditModal() {
            editModal.style.display = 'none';
            editIncidentForm.reset();
        }
        
        // Update incident
        function updateIncident(event) {
            event.preventDefault();
            
            const id = document.getElementById('editId').value;
            
            // Chỉ gửi các trường IncidentUpdateDTO cần
            const updatedIncident = {
                status: document.getElementById('editStatus').value,
                severityLevel: document.getElementById('editSeverityLevel').value,
                assignee: document.getElementById('editAssignee').value,
                resolved: false // Mặc định là false
            };
            
            console.log('Data being sent to API:', JSON.stringify(updatedIncident));
            
            fetch(`${API_BASE_URL}/incidents/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedIncident)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Refresh data
                fetchStats();
                fetchIncidents();
                closeEditModal();
                alert('Đã cập nhật sự cố thành công!');
            })
            .catch(error => {
                console.error('Error updating incident:', error);
                alert(`Lỗi khi cập nhật sự cố: ${error.message}`);
            });
        }
    </script>
</body>
</html>
